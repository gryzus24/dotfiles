#!/usr/bin/env -S python3 -S
from __future__ import annotations

import subprocess
import sys


def main() -> int:
    with subprocess.Popen(
        ('/usr/bin/pacman', '-Q', '-i'),
        stdout=subprocess.PIPE,
        env={'LC_ALL': 'C'},
        encoding='UTF-8'
    ) as p:
        sout, _ = p.communicate()

    check = ('Name', 'Installed Size')
    lines = [
        x[18:]
        for x in sout.splitlines()
        if x.startswith(check)
    ]

    maxwidth = total_bytes = 0
    packages: list[tuple[str, str, int]] = []
    for i in range(0, len(lines), 2):
        name = lines[i]
        if len(name) > maxwidth:
            maxwidth = len(name)

        ssize, _, unit = lines[i + 1].partition(' ')
        if unit == 'B':
            nbytes = int(float(ssize))
        elif unit == 'KiB':
            nbytes = int(float(ssize) * 1024)
        elif unit == 'MiB':
            nbytes = int(float(ssize) * (1024 ** 2))
        elif unit == 'GiB':
            nbytes = int(float(ssize) * (1024 ** 3))
        else:
            raise AssertionError('TiB+ conversion not implemented')

        total_bytes += nbytes
        packages.append((name, lines[i + 1], nbytes))

    total_gib = total_bytes / (1024 ** 3)

    sys.stdout.write(f'{"NUMBER OF PACKAGES":{maxwidth}} : {len(packages)}\n')
    sys.stdout.write(f'{"TOTAL SIZE ON DISK":{maxwidth}} : {total_gib:.3f} GiB\n')
    sys.stdout.write(18 * '=' + '\n')

    packages.sort(key=lambda x: x[2], reverse=True)
    for name, size, _ in packages:
        sys.stdout.write(f'{name:{maxwidth}} : {size}\n')

    return 0


if __name__ == '__main__':
    raise SystemExit(main())
