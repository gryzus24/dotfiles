#!/bin/dash

set -e
. libsh

usage() {
    echo \
        "usage: $(sh_prog) [--age | --rate]\n" \
        '  --age    sort by age (default)\n' \
        '  --rate   sort by rate'
}

sort_arg=age
case "$1" in
    -h|--help)
        usage
        exit 0
        ;;
    --age | '')
        sort_arg=age
        ;;
    --rate)
        sort_arg=rate
        ;;
    *)
        printf '%s: unrecognized option: %s\n' "$(sh_prog)" "$1"
        usage
        exit 1
        ;;
esac

sh_ensure_root

mlist=/etc/pacman.d/mirrorlist

reflector \
    --country PL,DE,CZ,SK,GB,FR \
    --latest 6 \
    --sort "${sort_arg}" \
    --protocol https \
    --save "${mlist}.tmp"

[ -f "${mlist}" ] && mv "${mlist}" "${mlist}.bak"
mv "${mlist}.tmp" "${mlist}"

rm -f "${mlist}.pacnew"

diff --color=auto -u "${mlist}.bak" "${mlist}"
